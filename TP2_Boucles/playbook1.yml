
---
- name: Installer Apache/MySQL et modifier la page si Apache était déjà installé
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    apache_index_path: /var/www/html/index.html
    apache_message: "Bonjour depuis Ansible\n"

  tasks:
    - name: Collecter l'état des paquets installés (avant toute installation)
       # Permet de savoir si apache2 était déjà présent AVANT ce play
      ansible.builtin.package_facts:
        manager: auto

    - name: Déterminer si apache2 était installé avant ce play
      ansible.builtin.set_fact:
        apache_installed_before: "{{ 'apache2' in (ansible_facts.packages | default({})) }}"

    - name: Installer les paquets requis (apache2 et mysql-server)
      ansible.builtin.apt:
        name:
          - apache2
          - mysql-server
        state: present
        update_cache: yes
      when: ansible_facts['os_family'] == 'Debian'
      tags: install

    # Étape complémentaire : ne modifier et démarrer qu'uniquement si apache2 était déjà installé
    - name: Mettre à jour la page index.html (uniquement si apache2 était déjà là)
      ansible.builtin.copy:
        content: "{{ apache_message }}"
        dest: "{{ apache_index_path }}"
        owner: root
        group: root
        mode: '0644'
      when: apache_installed_before | bool
      tags: update_apache_html

    - name: Démarrer/activer le service apache2 (uniquement si apache2 était déjà là)
      ansible.builtin.service:
        name: apache2
        state: started
        enabled: true
      when: apache_installed_before | bool
      tags: start_apache

